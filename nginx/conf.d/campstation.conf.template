# ‚ö†Ô∏è  IMPORTANT: AUTO-GENERATED CONFIGURATION
# server_name and ssl_certificate paths in this file are automatically updated
# by the ./init-ssl.sh script based on your selected Environment Profile.
# DO NOT MANUALLY EDIT DOMAINS HERE unless you know what you are doing.

# Health Check Î°úÍ∑∏ Ï†úÏô∏ ÌïÑÌÑ∞ÎßÅ (Fallback for missing nginx.conf map)
map "$remote_addr:$http_user_agent" $is_loggable {
    ~^127\.0\.0\.1:curl 0;
    default 1;
}

server {
    listen 80;
    server_name ${CAMPSTATION_DOMAIN};
    
    # SSL Ïù∏Ï¶ù Ï†Ñ HTTP Ï±åÎ¶∞ÏßÄ ÌóàÏö©
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Î™®Îì† HTTP ÏöîÏ≤≠ÏùÑ HTTPSÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name ${CAMPSTATION_DOMAIN};

    # üîó Canonical Domain Redirect
    if ($host != "${CAMPSTATION_DOMAIN}") {
        return 301 https://${CAMPSTATION_DOMAIN}$request_uri;
    }
    
    # HTTP/2 Î∞è Î≤ÑÌçº ÏµúÏ†ÅÌôî (ÎåÄÏö©Îüâ Sitemap ÎåÄÏùë)
    large_client_header_buffers 4 32k;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # SSL ÏÑ§Ï†ï (Í∏∞Î≥∏ Í≤ΩÎ°ú - init-ssl.sh Ïã§Ìñâ ÌõÑ Ïú†Ìö®)
    ssl_certificate /etc/letsencrypt/live/${PRIMARY_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${PRIMARY_DOMAIN}/privkey.pem;

    # Upload Limit
    client_max_body_size 100M;

    # Docker DNS Resolver (Dynamic Resolution)
    resolver 127.0.0.11 valid=30s;

    # Î≥¥Ïïà Ìó§Îçî
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(self), microphone=(), camera=(), payment=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://openapi.map.naver.com https://oapi.map.naver.com https://*.pstatic.net https://js.tosspayments.com; img-src 'self' data: https://*.naver.com https://*.naver.net https://*.pstatic.net https://assets.tosspayments.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.naver.com https://*.navercorp.com https://*.tosspayments.com; frame-src 'self' https://*.tosspayments.com; worker-src 'self' blob:;" always;


    # Custom Error Pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }

    # Rate limiting
    limit_req zone=general burst=200 nodelay;

    # --- üõ°Ô∏è SECURITY: ADVANCED HARDENING üõ°Ô∏è ---
    
    # 1. Block unwanted HTTP methods
    if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|PATCH|OPTIONS)$ ) {
        return 405;
    }

    # 2. Block Malicious User-Agents
    if ($http_user_agent ~* (acunetix|sqlmap|nikto|metasploit|gobuster|dirbuster|nmap|zenmap|nessus|openvas|vega|w3af|zap|burp|hydra|john|medusa|ncrack|onesixtyone|patator|snmpwalk|snmpcheck|enum4linux|smbmap|crackmapexec|exploitdb|searchsploit|payloads|fuzz|scanner|grabber)) {
        return 444;
    }

    # 3. Block common web attack patterns in URI and Query String
    if ($request_uri ~* ((\.\.|%2e%2e)(/|%2f|\\|%5c)) ) { return 444; } # Directory Traversal
    if ($query_string ~* (union|select|insert|update|delete|drop|count|truncate|eval|concat|char|base64|document\.|window\.|alert\(|cookie) ) { return 444; } # SQLi & XSS

    # --- üõ°Ô∏è SECURITY: BOT & EXPLOIT BLOCKING üõ°Ô∏è ---

    # 1. Block strict malicious extensions
    location ~* \.(php|phtml|phar|pl|py|cgi|sh|bash|sql|log|old|ini|swp|save|git|svn|hg|ds_store|lock|conf|yaml|yml|local|production|test|dev|backup|1|2|3)($|\.) {
        access_log off; log_not_found off; return 444;
    }

    # 2. Block specific sensitive files/filenames
    location ~* /(env|environment|printenv|phpinfo|info|secrets|keys|config|aws|credentials|sendgrid|firebase|gcloud|actuator|Makefile|Procfile|server-info|__debug__)($|\.) {
        access_log off; log_not_found off; return 444;
    }

    # 3. Block malicious directories/paths
    # 3. Block malicious directories/paths
    location ~* ^/(wp-|wordpress|admin|phpmyadmin|adminer|console|setup|install|backup|test|old|new|db-admin|debug|backend|private|_profiler|_ignition|_dev|aws|docker|kube|cgi-bin) {
        access_log off; log_not_found off; return 444;
    }
    
    # 4. Block Hidden Files (Dotfiles) except .well-known
    location ~ /\.(?!well-known).* {
        access_log off; log_not_found off; return 444;
    }
    
    # 5. Block AI Scrapers & Crawlers
    if ($http_user_agent ~* (GPTBot|ChatGPT|ClaudeBot|Claude-Web|CCBot|CommonCrawl|Bytespider|FacebookBot|Google-Extended|Amazonbot)) {
        return 444;
    }
    # ----------------------------------------------------


    # Naver Maps API Proxy (Next.js Route Handler)
    location /api/naver {
        set $frontend_upstream "http://campstation-frontend:3000";
        proxy_pass $frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API Routing
    location /api {
        set $backend_upstream "http://campstation-backend:8080";
        proxy_pass $backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # MinIO Storage (Images)
    # ^~ modifier prevents regex matching (static files block) from taking precedence
    location ^~ /storage/ {
        limit_req zone=general burst=200 nodelay;
        rewrite ^/storage/(.*) /$1 break;
        proxy_pass http://campstation-minio:9000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # MinIO Ìó§Îçî Ïà®ÍπÄ
        proxy_hide_header x-amz-request-id;
        proxy_hide_header x-minio-deployment-id;
    }

    # Ï†ïÏ†Å ÌååÏùº Ï∫êÏã± (HTTP2 Ïò§Î•ò Î∞©ÏßÄ Î∞è ÏÑ±Îä• ÏµúÏ†ÅÌôî)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|json|webmanifest)$ {
        limit_req zone=general burst=200 nodelay;
        set $frontend_upstream "http://campstation-frontend:3000";
        proxy_pass $frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Ï∫êÏã± ÏÑ§Ï†ï
        proxy_cache_valid 200 1y;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Ï§ëÏöî: Î≤ÑÌçºÎßÅ Í¥ÄÎ†® Î¨∏Ï†ú Ìï¥Í≤∞
        proxy_max_temp_file_size 0;
    }

    # Frontend (Next.js)
    location / {
        set $frontend_upstream "http://campstation-frontend:3000";
        proxy_pass $frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
