# ‚ö†Ô∏è  IMPORTANT: AUTO-GENERATED CONFIGURATION
# server_name and ssl_certificate paths in this file are automatically updated
# by the ./init-ssl.sh script based on your selected Environment Profile.

# HTTP -> HTTPS Redirect
server {
    listen 80;
    server_name ${GLAMPING_DOMAIN};
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS
server {
    listen 443 ssl;
    http2 on;
    server_name ${GLAMPING_DOMAIN};

    # SSL Certificates
    ssl_certificate /etc/letsencrypt/live/${PRIMARY_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${PRIMARY_DOMAIN}/privkey.pem;

    # Logs
    access_log /var/log/nginx/glamping_access.log combined;
    error_log /var/log/nginx/glamping_error.log;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    # CSP: Hardened baseline. If a third-party script breaks, add a precise source rather than broad wildcards.
    add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; frame-ancestors 'self'; object-src 'none'; form-action 'self'; script-src 'self' 'unsafe-inline' https://openapi.map.naver.com https://ncp-ncloud-maps.naver.com https://oapi.map.naver.com https://nrbe.pstatic.net; img-src 'self' data: blob: https://*.pstatic.net https://openapi.map.naver.com https://*.naver.net; style-src 'self' 'unsafe-inline'; connect-src 'self' https://naveropenapi.apigw.ntruss.com https://ncp-ncloud-maps.naver.com https://kr-col-ext.nelo.navercorp.com; worker-src 'self' blob:; frame-src 'self'; upgrade-insecure-requests;" always;


    # Custom Error Pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }


    # Rate limiting - MOVED TO location / TO EXCLUDE STATIC ASSETS

    # --- üõ°Ô∏è SECURITY: ADVANCED HARDENING üõ°Ô∏è ---
    
    # 1. Block unwanted HTTP methods
    if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|PATCH|OPTIONS)$ ) {
        return 405;
    }

    # 2. Block Malicious User-Agents (Flattened)
    if ($http_user_agent ~* (acunetix|sqlmap|nikto|metasploit|gobuster|dirbuster|nmap|zenmap|nessus|openvas|vega|w3af|zap|burp|hydra|john|medusa|ncrack|onesixtyone|patator|snmpwalk|snmpcheck|enum4linux|smbmap|crackmapexec|exploitdb|searchsploit|payloads|fuzz|scanner|grabber)) {
        return 444;
    }

    # 3. Block common web attack patterns in URI and Query String
    if ($request_uri ~* ((\.\.|%2e%2e)(/|%2f|\\|%5c)) ) { return 444; } # Directory Traversal
    if ($query_string ~* (union|select|insert|update|delete|drop|count|truncate|eval|concat|char|base64|document\.|window\.|alert\(|cookie) ) { return 444; } # SQLi & XSS

    # --- üõ°Ô∏è SECURITY: BOT & EXPLOIT BLOCKING (Existing) üõ°Ô∏è ---

    # 1. Block strict malicious extensions (End of string or followed by .)
    # Covers: .php, .php.1, .bak, .env, .git
    location ~* \.(php|phtml|phar|pl|py|cgi|sh|bash|sql|log|old|ini|swp|save|git|svn|hg|ds_store|lock|conf|yaml|yml|local|production|test|dev|backup|1|2|3)($|\.) {
        access_log off; log_not_found off; return 444;
    }

    # 2. Block specific sensitive files/filenames (regardless of extension or path)
    # Covers: /env, /env.js, /secrets.json, /config.js, /id_rsa, /printenv, /phpinfo
    location ~* /(env|environment|printenv|phpinfo|info|secrets|keys|config|aws|credentials|sendgrid|firebase|gcloud|actuator|Makefile|Procfile|server-info|__debug__)($|\.) {
        access_log off; log_not_found off; return 444;
    }

    # 3. Block malicious directories/paths (Prefix)
    # Covers: /wp-admin, /wordpress, /_next, /admin, /backend, /private
    location ~* ^/(wp-|wordpress|admin|phpmyadmin|adminer|console|dashboard|setup|install|backup|test|old|new|db-admin|debug|backend|private|_profiler|_ignition|_dev|aws|docker|kube|cgi-bin) {
        access_log off; log_not_found off; return 444;
    }
    
    # 4. Block Hidden Files (Dotfiles) except .well-known
    location ~ /\.(?!well-known).* {
        access_log off; log_not_found off; return 444;
    }

    # 5. Block AI Scrapers & Crawlers
    if ($http_user_agent ~* (GPTBot|ChatGPT|ClaudeBot|Claude-Web|CCBot|CommonCrawl|Bytespider|FacebookBot|Google-Extended|Amazonbot)) {
        return 444;
    }
    # ----------------------------------------------------

    # Proxy to Glamping Frontend
    location / {
        # Rate limiting applied HERE instead of server block to exclude assets
        limit_req zone=general burst=50 nodelay;

        proxy_pass http://glamping-frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static File Caching - Disable Rate Limiting for Assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|json|webmanifest)$ {
        proxy_pass http://glamping-frontend:3000;
        proxy_cache_valid 200 1y;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Allow Next.js Image Optimization - Disable Rate Limiting
    location /_next/image {
        proxy_pass http://glamping-frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
