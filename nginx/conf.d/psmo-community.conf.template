# ‚ö†Ô∏è  IMPORTANT: AUTO-GENERATED CONFIGURATION
# server_name and ssl_certificate paths in this file are automatically updated
# by the ./init-ssl.sh script based on your selected Environment Profile.
# DO NOT MANUALLY EDIT DOMAINS HERE unless you know what you are doing.

# Health Check Î°úÍ∑∏ Ï†úÏô∏ ÌïÑÌÑ∞ÎßÅ (Fallback for missing nginx.conf map)
map "$remote_addr:$http_user_agent" $is_loggable {
    ~^127\.0\.0\.1:curl 0;
    default 1;
}

# HTTP -> HTTPS Î¶¨Îã§Ïù¥Î†âÌä∏
server {
    listen 80;
    server_name ${PRIMARY_DOMAIN};
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS
server {
    listen 443 ssl;
    http2 on;
    server_name ${PRIMARY_DOMAIN};

    # üîó Canonical Domain Redirect
    if ($host != "${PRIMARY_DOMAIN}") {
        return 301 https://${PRIMARY_DOMAIN}$request_uri;
    }

    # HTTP/2 Î∞è Î≤ÑÌçº ÏµúÏ†ÅÌôî (ÎåÄÏö©Îüâ Sitemap ÎåÄÏùë)
    large_client_header_buffers 4 32k;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # SSL Ïù∏Ï¶ùÏÑú
    ssl_certificate /etc/letsencrypt/live/${PRIMARY_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${PRIMARY_DOMAIN}/privkey.pem;

    # Î°úÍ∑∏
    access_log /var/log/nginx/psmo_access.log combined if=$is_loggable;
    error_log /var/log/nginx/psmo_error.log;

    # Î≥¥Ïïà Ìó§Îçî (Security Headers)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; frame-ancestors 'self'; object-src 'none'; form-action 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://telegram.org https://cdn.jsdelivr.net; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; connect-src 'self' https://justadudewhohacks.github.io https://cdn.jsdelivr.net; worker-src 'self' blob: https://cdn.jsdelivr.net; frame-src 'self' https://telegram.org https://oauth.telegram.org; upgrade-insecure-requests;" always;


    # Custom Error Pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }

    # Rate limiting
    limit_req zone=general burst=50 nodelay;

    # --- üõ°Ô∏è SECURITY: ADVANCED HARDENING üõ°Ô∏è ---
    
    # 1. Block unwanted HTTP methods
    if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|PATCH|OPTIONS)$ ) {
        return 405;
    }

    # 2. Block Malicious User-Agents (Flattened)
    if ($http_user_agent ~* (acunetix|sqlmap|nikto|metasploit|gobuster|dirbuster|nmap|zenmap|nessus|openvas|vega|w3af|zap|burp|hydra|john|medusa|ncrack|onesixtyone|patator|snmpwalk|snmpcheck|enum4linux|smbmap|crackmapexec|exploitdb|searchsploit|payloads|fuzz|scanner|grabber)) {
        return 444;
    }

    # 3. Block common web attack patterns in URI and Query String
    if ($request_uri ~* ((\.\.|%2e%2e)(/|%2f|\\|%5c)) ) { return 444; } # Directory Traversal
    if ($query_string ~* (union|select|insert|update|delete|drop|count|truncate|eval|concat|char|base64|document\.|window\.|alert\(|cookie) ) { return 444; } # SQLi & XSS

    # --- üõ°Ô∏è SECURITY: BOT & EXPLOIT BLOCKING (Existing) üõ°Ô∏è ---

    # 1. Block strict malicious extensions (End of string or followed by .)
    # Covers: .php, .php.1, .bak, .env, .git
    location ~* \.(php|phtml|phar|pl|py|cgi|sh|bash|sql|log|old|ini|swp|save|git|svn|hg|ds_store|lock|conf|yaml|yml|local|production|test|dev|backup|1|2|3)($|\.) {
        access_log off; log_not_found off; return 444;
    }

    # 2. Block specific sensitive files/filenames (regardless of extension or path)
    # Covers: /env, /env.js, /secrets.json, /config.js, /id_rsa, /printenv, /phpinfo
    location ~* /(env|environment|printenv|phpinfo|info|secrets|keys|config|aws|credentials|sendgrid|firebase|gcloud|actuator|Makefile|Procfile|server-info|__debug__)($|\.) {
        access_log off; log_not_found off; return 444;
    }

    # 3. Block malicious directories/paths (Prefix)
    # Covers: /wp-admin, /wordpress, /_next, /admin, /backend, /private
    location ~* ^/(wp-|wordpress|admin|phpmyadmin|adminer|console|dashboard|setup|install|backup|test|old|new|db-admin|debug|backend|private|_profiler|_ignition|_dev|_next|aws|docker|kube|cgi-bin) {
        access_log off; log_not_found off; return 444;
    }
    
    # 4. Block Hidden Files (Dotfiles) except .well-known
    location ~ /\.(?!well-known).* {
        access_log off; log_not_found off; return 444;
    }

    # 5. Block AI Scrapers & Crawlers
    if ($http_user_agent ~* (GPTBot|ChatGPT|ClaudeBot|Claude-Web|CCBot|CommonCrawl|Bytespider|FacebookBot|Google-Extended|Amazonbot)) {
        return 444;
    }
    # ----------------------------------------------------


    # Frontend (Vue.js)
    location / {
        proxy_pass http://psmo-frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # SSE (Server-Sent Events) - Notifications
    location /api/notifications/stream {
        proxy_pass http://psmo-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_set_header Cache-Control 'no-cache';
        proxy_set_header X-Accel-Buffering 'no';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE ÏÑ§Ï†ï (Î≤ÑÌçºÎßÅ ÎÅî, Í∏¥ ÌÉÄÏûÑÏïÑÏõÉ)
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h; # 24ÏãúÍ∞Ñ Ïó∞Í≤∞ Ïú†ÏßÄ
        chunked_transfer_encoding off;
    }

    # Backend API
    location /api {
        limit_req zone=api burst=100 nodelay;
        
        proxy_pass http://psmo-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # MinIO Storage (Images)
    # ^~ modifier prevents regex matching (static files block) from taking precedence
    location ^~ /storage/ {
        limit_req zone=general burst=200 nodelay;
        rewrite ^/storage/(.*) /$1 break;
        proxy_pass http://psmo-minio:9000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # MinIO Ìó§Îçî Ïà®ÍπÄ
        proxy_hide_header x-amz-request-id;
        proxy_hide_header x-minio-deployment-id;
    }

    # WebSocket proxy (e.g., /ws/chat)
    location /ws/ {
        proxy_pass http://psmo-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
    }

    # Ï†ïÏ†Å ÌååÏùº Ï∫êÏã±
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|json|webmanifest)$ {
        limit_req zone=general burst=200 nodelay;
        proxy_pass http://psmo-frontend:3000;
        proxy_cache_valid 200 1y;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
